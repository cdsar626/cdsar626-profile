---
import { getCollection } from 'astro:content';
import ProjectCard from '../ui/ProjectCard.astro';

// Fetch projects
const allProjects = await getCollection('projects');

// Initial sort (Featured first)
const sortedProjects = allProjects.sort((a, b) => {
  if (a.data.featured && !b.data.featured) return -1;
  if (!a.data.featured && b.data.featured) return 1;
  // Use UTC for consistent comparison
  return new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime();
});

// Prepare data for the client-side script
const projectsData = sortedProjects.map(p => ({
  id: p.id,
  date: new Date(p.data.publishDate).getTime(),
  year: new Date(p.data.publishDate).getUTCFullYear(),
  featured: p.data.featured || false,
  order: p.data.order || 999
}));
---

<section class="projects-section" id="projects" aria-labelledby="projects-heading">
  <div class="projects-container">
    <header class="projects-header">
      <div class="projects-header-content">
        <h2 id="projects-heading" class="projects-title">Featured Projects</h2>
        <p class="projects-subtitle">
          A showcase of my recent work and technical expertise
        </p>
      </div>

      <!-- Gallery Controls -->
      <div class="gallery-controls">
        <div class="control-group">
          <label class="control-label">View Mode</label>
          <div class="custom-select" id="custom-select">
            <button class="select-trigger" id="select-trigger" aria-haspopup="listbox" aria-expanded="false">
              <span id="selected-text">âœ¨ Featured</span>
              <svg class="select-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div class="select-dropdown" id="select-dropdown">
              <ul class="select-options" role="listbox">
                <li class="select-option selected" data-value="featured" role="option">
                  <span class="option-icon">âœ¨</span> Featured 
                  <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                </li>
                <li class="select-option" data-value="timeline" role="option">
                  <span class="option-icon">ðŸ“…</span> Timeline
                  <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </header>
    
    <!-- Projects Grid Container -->
    <div id="projects-grid" class="projects-grid" role="list" data-view="featured">
      {sortedProjects.map((project) => (
        <div 
          class="projects-grid__item" 
          role="listitem"
          data-id={project.id}
          data-year={new Date(project.data.publishDate).getUTCFullYear()}
          data-featured={project.data.featured}
          data-date={new Date(project.data.publishDate).getTime()}
        >
          <ProjectCard
            title={project.data.title}
            description={project.data.description}
            technologies={project.data.technologies}
            thumbnail={project.data.thumbnail}
            links={project.data.links}
            featured={project.data.featured}
          />
        </div>
      ))}
    </div>
    
    <!-- Empty State -->
    <div id="empty-state" class="projects-empty" style="display: none;">
      <p>No projects available.</p>
    </div>
  </div>
</section>

<!-- Client-side Logic for Sorting and Resizing -->
<script define:vars={{ projectsData }}>
  document.addEventListener('DOMContentLoaded', () => {
    const grid = document.getElementById('projects-grid');
    const customSelect = document.getElementById('custom-select');
    const trigger = document.getElementById('select-trigger');
    const dropdown = document.getElementById('select-dropdown');
    const options = document.querySelectorAll('.select-option');
    const selectedText = document.getElementById('selected-text');
    const items = Array.from(document.querySelectorAll('.projects-grid__item'));

    if (!grid || !customSelect || !trigger || !dropdown) return;

    // --- 1. Sorting/Grouping Logic ---
    const updateView = (mode) => {
      // Remove all existing timeline headers/wrappers if any
      const existingHeaders = grid.querySelectorAll('.timeline-year-header');
      existingHeaders.forEach(el => el.remove());
      
      // Reset grid to default flat state implicitly by re-appending items sorted
      items.forEach(item => {
        item.style.display = ''; // Ensure visible
        grid.appendChild(item); // Moves it back to main grid
      });

      if (mode === 'featured') {
        grid.dataset.view = 'featured';
        // Sort by Featured -> Order -> Date
        items.sort((a, b) => {
          const featA = a.dataset.featured === 'true';
          const featB = b.dataset.featured === 'true';
          if (featA && !featB) return -1;
          if (!featA && featB) return 1;
          return Number(b.dataset.date) - Number(a.dataset.date);
        });
        items.forEach(item => grid.appendChild(item));
      } 
      else if (mode === 'timeline') {
        grid.dataset.view = 'timeline';
        
        // Group by Year
        const years = {};
        items.forEach(item => {
          const year = item.dataset.year;
          if (!years[year]) years[year] = [];
          years[year].push(item);
        });

        // Sort years descending
        const sortedYears = Object.keys(years).sort((a, b) => Number(b) - Number(a));

        // Create visual groups
        sortedYears.forEach(year => {
          // Create Header
          const header = document.createElement('div');
          header.className = 'timeline-year-header';
          header.innerHTML = `<h3 class="year-title">${year}</h3><div class="year-line"></div>`;
          grid.appendChild(header);

          // Append items for this year
          years[year].sort((a, b) => Number(b.dataset.date) - Number(a.dataset.date));
          years[year].forEach(item => grid.appendChild(item));
        });
      }
    };

    // --- 2. Custom Dropdown Logic ---
    const triggerSort = (mode) => {
      localStorage.setItem('projects_view_mode', mode);
      
      grid.style.opacity = '0';
      grid.style.transform = 'translateY(10px)';
      
      setTimeout(() => {
        updateView(mode);
        grid.style.opacity = '1';
        grid.style.transform = 'translateY(0)';
      }, 300);
    };

    const toggleDropdown = () => {
      const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
      trigger.setAttribute('aria-expanded', !isExpanded);
      dropdown.classList.toggle('active');
    };

    trigger.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleDropdown();
    });

    document.addEventListener('click', () => {
      trigger.setAttribute('aria-expanded', 'false');
      dropdown.classList.remove('active');
    });

    options.forEach(option => {
      option.addEventListener('click', (e) => {
        e.stopPropagation();
        const value = option.dataset.value;
        const text = option.textContent.trim();
        
        options.forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
        selectedText.textContent = text;
        
        trigger.setAttribute('aria-expanded', 'false');
        dropdown.classList.remove('active');

        triggerSort(value);
      });
    });

    // --- 3. Initialization ---
    const savedMode = localStorage.getItem('projects_view_mode') || 'featured';
    const initialOption = Array.from(options).find(opt => opt.dataset.value === savedMode);
    
    if (initialOption) {
      options.forEach(opt => opt.classList.remove('selected'));
      initialOption.classList.add('selected');
      selectedText.textContent = initialOption.textContent.trim();
    }
    
    updateView(savedMode);



  });
</script>

<style>
  .projects-section {
    padding: var(--space-20) 0;
    background: var(--color-gray-50);
    position: relative;
    min-height: 100vh;
  }
  
  .projects-container {
    max-width: var(--max-width-7xl); /* Wider for gallery */
    margin: 0 auto;
    padding: 0 var(--space-6);
  }
  
  .projects-header {
    text-align: left;
    margin-bottom: var(--space-8);
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    flex-wrap: wrap;
    gap: var(--space-6);
  }

  .projects-header-content {
    flex: 1;
    min-width: 300px;
  }

  /* --- Controls Styling --- */
  .gallery-controls {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    background: transparent;
    padding: 0;
    border: none;
    box-shadow: none;
    margin-bottom: var(--space-4);
  }

  .control-group {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: var(--space-3);
  }

  .control-label {
    font-size: 10px;
    font-weight: var(--font-weight-bold);
    color: var(--color-gray-400);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    white-space: nowrap;
  }

  .custom-select {
    position: relative;
    width: 220px;
  }

  .select-trigger {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--color-bg-surface);
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    padding: var(--space-3) var(--space-4);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-gray-900);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    box-shadow: var(--shadow-sm);
  }

  .select-trigger:hover {
    border-color: var(--color-primary);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .select-trigger[aria-expanded="true"] .select-icon {
    transform: rotate(180deg);
  }

  .select-icon {
    width: 16px;
    height: 16px;
    color: var(--color-gray-400);
    transition: transform 0.3s ease;
  }

  .select-dropdown {
    position: absolute;
    top: calc(100% + var(--space-2));
    left: 0;
    right: 0;
    background: var(--color-bg-surface);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--color-gray-300);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px) scale(0.95);
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    overflow: hidden;
  }

  .select-dropdown.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
  }

  .select-options {
    list-style: none;
    padding: var(--space-1);
    margin: 0;
  }

  .select-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-3) var(--space-4);
    font-size: var(--font-size-sm);
    color: var(--color-gray-700);
    cursor: pointer;
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
  }

  .select-option:hover {
    background: var(--color-gray-200);
    color: var(--color-primary);
  }

  .select-option.selected {
    background: var(--color-primary-light);
    color: var(--color-primary-dark);
    font-weight: var(--font-weight-semibold);
  }

  .check-icon {
    width: 16px;
    height: 16px;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .select-option.selected .check-icon {
    opacity: 1;
  }

  :global([data-theme="dark"]) .select-trigger {
    background: rgba(15, 23, 42, 0.8);
    border-color: rgba(255, 255, 255, 0.1);
    color: var(--color-gray-900);
  }

  :global([data-theme="dark"]) .select-dropdown {
    background: rgba(15, 23, 42, 0.8); /* Semi-transparent indigo-dark */
    border-color: rgba(255, 255, 255, 0.1);
  }

  :global([data-theme="dark"]) .select-option:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  :global([data-theme="dark"]) .select-option.selected {
    background: rgba(59, 130, 246, 0.2);
    color: var(--color-primary-light);
  }



  /* --- Grid Styling --- */
  .projects-grid {
    display: grid;
    /* Fixed at 350px for approximately 3 cards per row on desktop */
    --card-min-width: 350px; 
    grid-template-columns: repeat(auto-fill, minmax(var(--card-min-width), 1fr));
    gap: var(--space-8);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  .projects-grid__item {
    /* Ensure cards take full height of grid cell */
    height: 100%;
    animation: fadeIn 0.5s ease-out forwards;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* --- Timeline Headers (inserted dynamically) --- */
  :global(.timeline-year-header) {
    grid-column: 1 / -1; /* Span full width */
    display: flex;
    align-items: center;
    gap: var(--space-6);
    margin-top: var(--space-8);
    margin-bottom: var(--space-4);
    animation: fadeIn 0.5s ease-out;
  }

  :global(.year-title) {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-gray-300);
    margin: 0;
    line-height: 1;
  }

  :global(.year-line) {
    flex: 1;
    height: 2px;
    background: var(--color-gray-200);
    border-radius: 99px;
  }

  /* --- Titles & Text --- */
  .projects-title {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-gray-900);
    margin-bottom: var(--space-2);
    line-height: var(--line-height-tight);
  }
  
  .projects-subtitle {
    font-size: var(--font-size-lg);
    color: var(--color-gray-600);
    max-width: 600px;
    margin: 0;
    line-height: var(--line-height-relaxed);
  }
  
  .projects-empty {
    text-align: center;
    padding: var(--space-20);
    color: var(--color-gray-500);
    font-size: var(--font-size-lg);
  }

  /* --- Dark Mode & Responsive --- */
  @media (min-width: 768px) {
    .projects-container {
      padding: 0 var(--space-8);
    }
  }

  @media (max-width: 640px) {
    .gallery-controls {
      flex-direction: column;
      align-items: stretch;
    }
    .select-wrapper {
      width: 100%;
    }
    .projects-grid {
      --card-min-width: 100% !important; /* Force single column on mobile */
    }
  }

  /* Dark mode overrides (if global.css handles vars, this might be redundant but safe) */
  @media (prefers-color-scheme: dark) {
     /* Add dark mode specific overrides if variables don't cover it */
  }
</style>