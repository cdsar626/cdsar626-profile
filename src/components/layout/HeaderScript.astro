---
// This component provides the client-side script for header interactions
---

<script>
  // CV Viewer state management
  let cvViewerInstance: any = null;
  let isInitialized = false;

  // Initialize CV viewer functionality
  function initializeCVViewer() {
    if (isInitialized) return;

    const cvButton = document.getElementById('cv-button');
    if (!cvButton) return;

    // Create CV viewer container if it doesn't exist
    let cvViewerContainer = document.getElementById('cv-viewer-container');
    if (!cvViewerContainer) {
      cvViewerContainer = document.createElement('div');
      cvViewerContainer.id = 'cv-viewer-container';
      document.body.appendChild(cvViewerContainer);
    }

    // Handle CV button click
    cvButton.addEventListener('click', async () => {
      try {
        // Dynamically import and mount the Vue CV viewer component
        if (!cvViewerInstance) {
          const { createApp } = await import('vue');
          const CVViewer = await import('../ui/CVViewer.vue');
          
          const app = createApp({
            components: {
              CVViewer: CVViewer.default
            },
            data() {
              return {
                isOpen: false,
                cvAssets: [],
                defaultCvPath: '/cv/sample-cv.pdf'
              };
            },
            methods: {
              openCV() {
                this.isOpen = true;
                // Update button ARIA state
                cvButton.setAttribute('aria-expanded', 'true');
              },
              closeCV() {
                this.isOpen = false;
                // Update button ARIA state
                cvButton.setAttribute('aria-expanded', 'false');
                // Return focus to the button
                cvButton.focus();
              }
            },
            template: `
              <CVViewer 
                :isOpen="isOpen" 
                :cvAssets="cvAssets"
                :defaultCvPath="defaultCvPath"
                @close="closeCV"
              />
            `
          });

          cvViewerInstance = app.mount(cvViewerContainer);
        }

        // Open the CV viewer
        cvViewerInstance.openCV();

        // Add analytics tracking if available
        if (typeof (window as any).gtag !== 'undefined') {
          (window as any).gtag('event', 'cv_view', {
            event_category: 'engagement',
            event_label: 'header_button'
          });
        }

      } catch (error) {
        console.error('Failed to load CV viewer:', error);
        
        // Show user-friendly error message
        const errorMessage = 'Unable to load CV viewer. Opening CV in new tab instead.';
        
        // Create a temporary alert for screen readers
        const alertDiv = document.createElement('div');
        alertDiv.setAttribute('role', 'alert');
        alertDiv.setAttribute('aria-live', 'assertive');
        alertDiv.textContent = errorMessage;
        alertDiv.style.position = 'absolute';
        alertDiv.style.left = '-10000px';
        document.body.appendChild(alertDiv);
        
        // Remove the alert after screen readers have announced it
        setTimeout(() => {
          document.body.removeChild(alertDiv);
        }, 1000);
        
        // Fallback: try to open CV in new tab
        const fallbackUrl = '/cv/sample-cv.pdf';
        window.open(fallbackUrl, '_blank', 'noopener,noreferrer');
      }
    });

    // Handle keyboard navigation
    cvButton.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        cvButton.click();
      }
    });

    // Add visual feedback for touch devices
    if ('ontouchstart' in window) {
      cvButton.addEventListener('touchstart', () => {
        cvButton.style.transform = 'scale(0.98)';
      });

      cvButton.addEventListener('touchend', () => {
        cvButton.style.transform = '';
      });
    }

    isInitialized = true;
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeCVViewer);
  } else {
    initializeCVViewer();
  }

  // Re-initialize if navigating with client-side routing
  document.addEventListener('astro:page-load', initializeCVViewer);
</script>