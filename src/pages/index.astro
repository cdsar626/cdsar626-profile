---
import BaseLayout from '../layouts/BaseLayout.astro';
import ProfileSection from '../components/sections/ProfileSection.astro';
import IntroSection from '../components/sections/IntroSection.astro';
import ProjectsSection from '../components/sections/ProjectsSection.astro';
import { getCollection } from 'astro:content';
import { generatePortfolioStructuredData, generateFAQStructuredData, generateKeywords, sanitizeSEOData } from '../utils/seo.ts';
import '../styles/global.css';
import profileImage from "../assets/images/profile/linkedin-avatar.png"

// Fetch projects for SEO data generation
const projects = await getCollection('projects');
const sortedProjects = projects.sort((a, b) => a.data.order - b.data.order);

// Generate enhanced SEO data
const keywords = generateKeywords(projects, [
  'developer', 'portfolio', 'full-stack', 'web development', 'software engineer',
  'react', 'vue.js', 'node.js', 'typescript', 'javascript', 'astro'
]);

const seoData = sanitizeSEOData({
  title: 'Cesar De la Vega - Full Stack Software Developer Portfolio',
  description: 'Experienced full-stack developer specializing in Flutter, Vue.js, Node.js, and modern web technologies. View my projects, skills, and professional experience.',
  keywords: keywords,
  type: 'website',
  author: 'Cesar De la Vega',
  modifiedDate: new Date()
});

// Generate structured data
const portfolioStructuredData = generatePortfolioStructuredData(sortedProjects);
const faqStructuredData = generateFAQStructuredData();
---

<BaseLayout {...seoData}>
  <main id="main-content" role="main" aria-label="Portfolio content">
    <!-- Skip link for accessibility -->
    <a href="#projects" class="skip-link sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:bg-primary focus:text-white focus:px-4 focus:py-2 focus:rounded">
      Skip to projects
    </a>
    
    <ProfileSection 
      name="Cesar De la Vega"
      role="Software Developer / Fullstack"
      data-animate-on-scroll
      data-stagger="0"
      profileImageSrc={profileImage.src}
    />
    <IntroSection 
      content="I'm a passionate full-stack developer with expertise in modern web technologies. I love creating efficient, scalable solutions and bringing ideas to life through clean, maintainable code. With a focus on user experience and performance, I strive to build applications that make a difference."
      fadeInDelay={0.8}
      data-animate-on-scroll
      data-stagger="0.2"
    />
    <ProjectsSection 
      data-animate-on-scroll
      data-stagger="0.4"
    />
  </main>

  <!-- Additional Structured Data for Portfolio -->
  <script type="application/ld+json" is:inline set:html={JSON.stringify(portfolioStructuredData)}></script>
  
  <!-- FAQ Structured Data -->
  <script type="application/ld+json" is:inline set:html={JSON.stringify(faqStructuredData)}></script>
  
  <!-- Final Polish: Enhanced Micro-interactions -->
  <script>
    // @ts-nocheck
    document.addEventListener('DOMContentLoaded', () => {
      // Add smooth scroll behavior for internal links
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute('href'));
          if (target) {
            target.scrollIntoView({
              behavior: 'smooth',
              block: 'start'
            });
          }
        });
      });

      // Add subtle parallax effect to profile section
      const profileSection = document.querySelector('[data-section="profile"]');
      if (profileSection && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        let ticking = false;
        
        function updateParallax() {
          const scrolled = window.pageYOffset;
          const rate = scrolled * -0.5;
          profileSection.style.transform = `translateY(${rate}px)`;
          ticking = false;
        }
        
        function requestTick() {
          if (!ticking) {
            requestAnimationFrame(updateParallax);
            ticking = true;
          }
        }
        
        window.addEventListener('scroll', requestTick, { passive: true });
      }

      // Add loading state management
      const images = document.querySelectorAll('img');
      let loadedImages = 0;
      const totalImages = images.length;
      
      if (totalImages > 0) {
        images.forEach(img => {
          if (img.complete) {
            loadedImages++;
          } else {
            img.addEventListener('load', () => {
              loadedImages++;
              if (loadedImages === totalImages) {
                document.body.classList.add('images-loaded');
              }
            });
          }
        });
        
        if (loadedImages === totalImages) {
          document.body.classList.add('images-loaded');
        }
      } else {
        document.body.classList.add('images-loaded');
      }

      // Add focus management for better keyboard navigation
      const focusableElements = document.querySelectorAll(
        'a[href], button, input, textarea, select, details, [tabindex]:not([tabindex="-1"])'
      );
      
      // Add focus indicators for better accessibility
      focusableElements.forEach(element => {
        element.addEventListener('focus', () => {
          element.classList.add('focused');
        });
        
        element.addEventListener('blur', () => {
          element.classList.remove('focused');
        });
      });

      // Performance optimization: Preload critical resources
      const criticalResources = [
        '/assets/images/profile/profile-placeholder.svg',
        '/fonts/inter-var.woff2'
      ];
      
      criticalResources.forEach(resource => {
        const link = document.createElement('link');
        link.rel = 'prefetch';
        link.href = resource;
        document.head.appendChild(link);
      });

      // Add intersection observer for performance metrics
      if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              // Mark section as visible for analytics
              const section = entry.target.getAttribute('data-section') || 'unknown';
              console.log(`Section "${section}" is now visible`);
              
              // Add visible class for any additional styling
              entry.target.classList.add('section-visible');
            }
          });
        }, {
          threshold: 0.1,
          rootMargin: '0px 0px -50px 0px'
        });

        // Observe all main sections
        document.querySelectorAll('section, [data-section]').forEach(section => {
          observer.observe(section);
        });
      }
    });
  </script>

  <!-- Final Polish: Additional CSS for micro-interactions -->
  <style>
    /* Skip link styling */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 6px;
      background: var(--color-primary);
      color: white;
      padding: 8px;
      text-decoration: none;
      border-radius: 4px;
      z-index: 1000;
      transition: top 0.3s;
    }
    
    .skip-link:focus {
      top: 6px;
    }

    /* Enhanced focus indicators */
    .focused {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
      border-radius: 4px;
    }

    /* Loading state improvements */
    body:not(.images-loaded) img {
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    
    body.images-loaded img {
      opacity: 1;
    }

    /* Section visibility animations */
    .section-visible {
      animation: sectionReveal 0.6s ease-out forwards;
    }

    @keyframes sectionReveal {
      from {
        opacity: 0.8;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Enhanced hover states for better feedback */
    a:hover, button:hover {
      transform: translateY(-1px);
      transition: transform 0.2s ease-out;
    }

    /* Smooth transitions for all interactive elements */
    a, button, input, textarea, select {
      transition: all 0.2s ease-in-out;
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      .focused {
        outline: 3px solid;
        outline-color: Highlight;
      }
    }

    /* Reduced motion overrides */
    @media (prefers-reduced-motion: reduce) {
      .section-visible {
        animation: none;
      }
      
      a:hover, button:hover {
        transform: none;
      }
      
      * {
        transition-duration: 0.01ms !important;
        animation-duration: 0.01ms !important;
      }
    }

    /* Print optimizations */
    @media print {
      .skip-link {
        display: none;
      }
      
      main {
        padding: 0;
        margin: 0;
      }
      
      section {
        page-break-inside: avoid;
        margin-bottom: 2rem;
      }
    }
  </style>
</BaseLayout>
